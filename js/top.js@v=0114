
const ww = window.innerWidth;
const wh = window.innerHeight;
const hw = ww / 2;
const hh = wh / 2;
const pm = 150; // parallax margin
const pllx_mov_val = -1 * 0.2;
const pllx_scrl_val = 20;

$(document).on("mousemove", function(e) {
	const mw = ( e.clientX - hw ) / hw * ( pm / 2 );
	const mh = ( e.clientY - hh ) / hh * ( pm / 2 );
	setTimeout(function(){
		$('#PllxScene .background img').stop().animate({"top": (mh * pllx_mov_val * 1.2) + "px"},200);
		$('#PllxScene .background-flush img').stop().animate({"top": (mh * pllx_mov_val * 1.2) + "px"},200);
		// $('#PllxScene .chr1 img').stop().animate({"left": (mw * pllx_mov_val * 1) + "px"},200);
		// $('#PllxScene .chr2 img').stop().animate({"left": (mw * pllx_mov_val * 1.25) + "px"},200);
		// $('#PllxScene .chr3 img').stop().animate({"left": (mw * pllx_mov_val * 1.5) + "px"},200);
	}, 200);
});
/*
$(window).scroll(function(){
     var y = $(this).scrollTop();
		$('#PllxScene .background img').css("top", parseInt( -y / pllx_scrl_val ) * .5);
		$('#PllxScene .background-flush img').css("top", parseInt( -y / pllx_scrl_val ) * .5);
		$('#PllxScene .chr1 img').css("top", parseInt( -y / pllx_scrl_val ) * .8);
		$('#PllxScene .chr2 img').css("top", parseInt( -y / pllx_scrl_val ) * 1.3);
		$('#PllxScene .chr3 img').css("top", parseInt( -y / pllx_scrl_val ) * 1.8);
});
*/
var jqvw;
var jqvh;
var visw;
var vish;
var vistop;
var visdy = 0;//初期位置
var visdl = 3000;//移動までのディレイ
var visdt = 2000;//移動時間
var vem = 18;
var loaddt = 2000;
var vy_logo_d;
var is_loaded = false;
$(document).ready( function(){
	jqvw = $(window).innerWidth();
	jqvh = $(window).innerHeight();
	visw = $("#MainVisual").width();
	vish = $("#MainVisual").height();
	var vemText = $("body").css("font-size");
	vemText = vemText.replace("px", "");
	vem = Number(vemText);
	//console.log("jqvw:"+jqvw +"/jqvh:"+jqvh+"/visw:"+visw+"/vish:"+vish+"/vem:"+vem);

	//横長画面でのビジュアルの出現時縦位置、正常位置への移動時間を設定
	if(vish>jqvh){
		visdy = ((vish - jqvh)) ;
		visdl = 5000;
		visdt = 2000;
	}
	//console.log("visdy:"+visdy +"/visdt:"+visdt);
	//初回訪問チェック
	var checkCookie = document.cookie;
	if(checkCookie.match("XXX")){
  		//console.log("2nd visit")
		$("body").addClass("vst");
		openPage();
	}else{
  		var domain = document.domain;
  		var visitorCookie = 'visitorCookie="XXX"; domain='+domain+'; path="/";';
  		document.cookie = visitorCookie;
  		//console.log("fst visit")
		$("body").addClass("fst");
		mainVisLoop();
	}
	//mainVisLoop();
	//dbg();
	//var lightbox = lity('#Modal_1');
	//cutText(40,'#news-hd .hdl a');
});
$(window).load(function(){
	is_loaded = true;
	newsGet(4,"./news/index.html");
	//console.log("window.load / is_loaded = "+is_loaded);
});

function mainVisLoop(kyd){
	//縦位置をリセット
	setTimeout(function(){
	$(window).scrollTop(visdy)
	$('body,html').animate({ scrollTop:visdy}, 0, 'easeInOutCubic')
	//$(".visual-container").animate({top:visdy}, 0);
	//console.log("visdy:"+visdy +"/visdt:"+visdt);
	}, 100);
	if( !kyd ){
		//ロード
		setTimeout(function(){
			$(".loadpane-container").addClass("anm1");
		}, 100);
		// setTimeout(function(){
		// 	$(".loadpane-container").addClass("anm2");
		// }, 2500);
		// setTimeout(function(){
		// 	$(".cont-top-loadpane").hide("");
		// }, 7000);
	}else{
		$(".cont-top-loadpane").hide("");
	}
	if( kyd == 1 ){ loaddt = 0; }
	//表示開始
	setTimeout(function(){
		waitLoad();
	}, loaddt + 100);
}
function waitLoad(){
	setTimeout(function(){
		if(is_loaded){
			closeLoader();
			//console.log("waitLoad() / is_loaded = "+is_loaded);
		}else{
			waitLoad();
			//console.log("waitLoad() / is_loaded = "+is_loaded);
		}
	}, 500);
}
function closeLoader(){
	setTimeout(function(){
		$(".loadpane-container").addClass("anm2");
	}, 100);
	setTimeout(function(){
		openPage();
	}, 4600);
}
function openPage(){
	setTimeout(function(){
		$(".cont-top-loadpane").hide();
	}, 0);
	//表示開始
	setTimeout(function(){
		$(".visual-container").addClass("anm1");
	}, 100);
	//移動
	setTimeout(function(){
		$('body,html').animate({ scrollTop:0}, visdt, 'easeInOutCubic')
		//$(".visual-container").animate({top:0}, visdt);
	}, visdl);
	//移動終了
	setTimeout(function(){
			$('.top-page #SPNavi').fadeIn(1500);
			$('.top-page .part-header').fadeIn(1500);
			$('.top-page .part-footer').fadeIn(1500);
			$('.top-page .part-body-middle').fadeIn(1500);
	}, visdl + visdt);
	setTimeout(function(){
		$(".visual-container").addClass("anm2");
		pllxEyecatch("#PLX1","#PLX1_CNT");
	}, visdl + visdt + 1000);
}
function dbg(){
	openPage();
}

function cutText(num,trg) {
   var count = 20;
   if(num > 0){ count = num }
 $(trg).each(function() {
     var thisText = $(this).text();
      var textLength = thisText.length;
       if (textLength > count) {
          var showText = thisText.substring(0, count);
          var insertText = showText += '...';
          $(this).html(insertText);
      };
  });
};

function visChrFix(){
	var ww = window.innerWidth;
	var wh = window.innerHeight;
	var swd = wh - (69.333 * ww * 0.01);
	var jh = ww/wh;
	//console.log("swd:"+swd+"/jh:"+jh);
	if(jh > 2.1){
		$(".cont-top-visual").css("max-height","inherit");
		$(".visual-container").css("max-height","inherit");
	}else if(jh > 1.8){
		if(ww > 2000 && swd < 0){
			$(".visual-container .chr1").css("top",11.5*ww * 0.01 + 0.5*swd);
			$(".visual-container .chr2").css("top",11.5*ww * 0.01 + 0.5*swd);
			$(".visual-container .chr3").css("top",16*ww * 0.01 + 0.5*swd);
		}
		if(ww < 2000 && swd < 0){
			$(".visual-container .chr1").css("top",11.5*ww * 0.01 + 0.05*swd);
			$(".visual-container .chr2").css("top",11.5*ww * 0.01 + 0.05*swd);
			$(".visual-container .chr3").css("top",16*ww * 0.01 + 0.05*swd);
			//console.log("d:"+(1+0.0005*swd));
			$(".visual-container .chr1").width(56.2*ww * 0.01 * (1+0.0005*swd*2));
			$(".visual-container .chr2").width(21.3*ww * 0.01 * (1+0.0005*swd*2));
			$(".visual-container .chr3").width(20.36*ww * 0.01 * (1+0.0005*swd*2));
		
			$(".visual-container .chr1").css("left",50*ww * 0.01 - 28.6*ww * 0.01  * (1+0.0005*swd*2));
			$(".visual-container .chr2").css("left",50*ww * 0.01 - 30.3*ww * 0.01  * (1+0.0005*swd*2));
			$(".visual-container .chr3").css("left",50*ww * 0.01 + 13.93*ww * 0.01  * (1+0.0005*swd*2));
			if(ww < 2000){
				$(".visual-container .season1-btn").width(17.33*ww * 0.01 * (1+0.0005*swd*2.5));
				$(".visual-container .season1-btn").css("bottom",11.333*ww * 0.01 + 0.25*swd*0.3);
			}
		}
	}
}

/* ◆ニュース記事スクレイプ ------------------------------ */
function newsGet(number,newsurl){
	var target_url="./news/index.html";
	if(newsurl) target_url=newsurl;
	$.ajax({
		url: target_url,
		success : function(data){
			$("#news-hd dl").remove();
			var entry_list= $("#NewsData",data);
			var count=0;
			var max_length=5;
			if(number) max_length=number;
			//var entries=[];
			//console.log(entry_list)
			$(".news-data",entry_list).slice(0,max_length).each(function() {
				var entry_date=$(".date",this).html();
				var entry_id=$(this).attr("id");
				var entry_title=$(".title span",this).text();
				var entry_title_lgt = 40;//文字数MAX
      			var textLength = entry_title.length;
       			if (textLength > entry_title_lgt) {
          			var showText = entry_title.substring(0, entry_title_lgt);
          			var insertText = showText += '...';
          			entry_title = insertText;
      			};
				//console.log(entry_title)
				var cnt='<dl><dt>'+entry_date+'</dt><dd class="hdl"><a class="flw-no hv_color" href="'+target_url+'#'+ entry_id +'">'+entry_title+'</a></dt></dl>'
				
				$("#news-hd").append(cnt);
				
				//console.log(cnt)
			});
		},
		error: function(data){
			$("#news-hd").html("<dl><dd>Error. Failed to load data.</dd></dl>");
		}
	});
}